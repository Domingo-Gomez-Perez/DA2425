#lang racket

; Exercise 3.11

(define (make-account balance)
  (define (withdraw amount)
    (if (>= balance amount)
        (begin (set! balance (- balance amount)) balance)
        "Insufficient funds"))

  (define (deposit amount)
    (set! balance (+ balance amount)) balance)

  (define (dispatch m)
    (cond 
        ((eq? m 'withdraw) withdraw)
        ((eq? m 'deposit) deposit)
        (else (error "Unknown request: MAKE-ACCOUNT" m))))

  dispatch
)

; Show the environment structure generated by the sequence of interactions

(define acc (make-account 50))
((acc 'deposit) 40)
((acc 'withdraw) 60)
(define acc2 (make-account 100))



; Evaluation of (define acc (make-account 50))
; 
; We call the `make-account` function with the argument 50. Then the environment
; E1 is created, which contains the functions `withdraw`, `deposit`, and `dispatch`.
; Meanwhile, in E1, a local variable balance is created and stores the value 50.
; Finally, the dispatch function is returned, which is assigned to acc and
; is stored in global_env.
;
;  _________________________________________________________
; |                                                         |
; |    global env:                                          |
; |            - make-account:   - Function code            |
; |                              - Pointer: global_env      |
; |            - acc:  o                                    |
; |____________________|____________________________________|
;                      |             ↑     
;                      |             |     
;                      |             |     
;  ____________________↓_____________|________________________ 
; |                 |                                         |
; |     code        |     environment: E1                     |
; |_________________|-----------------------------------------|
;                   |     balance: 50                         |
;                   |                                         |
;                   |     withdraw:   - Function code         |
;                   |                 - Pointer: E1           |
;                   |                                         |
;                   |     deposit:    - Function code         |
;                   |                 - Pointer: E1           |
;                   |                                         |
;                   |     dispatch:   - Function code         |
;                   |                 - Pointer: E1           |
;                   |_________________________________________|




; Evaluation of ((acc 'deposit) 40)
; 
; We call (acc 'deposit), which will execute the `dispatch` function with the
; argument 'deposit, thus returning the `deposit` function. This function
; will take the value 40 as an argument and update the local value of `balance`
; in E1 (balance = balance + 40).
;
;  _________________________________________________________
; |                                                         |
; |    global env:                                          |
; |            - make-account:   - Function code            |
; |                              - Pointer: global_env      |
; |            - acc:  o                                    |
; |____________________|____________________________________|
;                      |             ↑     
;                      |             |     
;                      |             |     
;  ____________________↓_____________|________________________ 
; |                 |                                         |
; |     code        |     environment: E1                     |
; |_________________|-----------------------------------------|
;                   |     balance: 90                         |
;                   |                                         |
;                   |     withdraw:   - Function code         |
;                   |                 - Pointer: E1           |
;                   |                                         |
;                   |     deposit:    - Function code         |
;                   |                 - Pointer: E1           |
;                   |                                         |
;                   |     dispatch:   - Function code         |
;                   |                 - Pointer: E1           |
;                   |_________________________________________|




; Evaluation of ((acc 'withdraw) 60)
; 
; We call (acc 'withdraw), which will execute the `dispatch` function with the
; argument 'withdraw, thus returning the `withdraw` function. This function
; will take the value 60 as an argument and update the local value of `balance`
; in E1 (balance = balance - 60).
;
;  _________________________________________________________
; |                                                         |
; |    global env:                                          |
; |            - make-account:   - Function code            |
; |                              - Pointer: global_env      |
; |            - acc:  o                                    |
; |____________________|____________________________________|
;                      |             ↑     
;                      |             |     
;                      |             |     
;  ____________________↓_____________|________________________ 
; |                 |                                         |
; |     code        |     environment: E1                     |
; |_________________|-----------------------------------------|
;                   |     balance: 30                         |
;                   |                                         |
;                   |     withdraw:   - Function code         |
;                   |                 - Pointer: E1           |
;                   |                                         |
;                   |     deposit:    - Function code         |
;                   |                 - Pointer: E1           |
;                   |                                         |
;                   |     dispatch:   - Function code         |
;                   |                 - Pointer: E1           |
;                   |_________________________________________|






; Where is the local state for `acc` kept? 
;
; The local state of `acc` is kept in environment E1, which stores
; both the balance variable and the functions.



; Suppose we define another account (define acc2 (make-account 100))
;
; As before, we call the `make-account` function with the argument 100.
; Then the environment E2 is created, which contains the functions `withdraw`,
; `deposit`, and `dispatch`. In E2, a local variable `balance` is created and 
; stores the value 100. Finally, the dispatch function is returned, which is 
; assigned to `acc2` and is stored in global_env.
;
;  __________________________________________________________________________________________________________________________________
; |                                                                                                                                  |
; |    global env:                                                                                                                   |
; |            - make-account:   - Function code                                                                                     |
; |                              - Pointer: global_env                                                                               |
; |                                                                                                                                  |
; |            - acc2: o---------------------------------------------------------------------+                                       |
; |                                                                                          |                                       |
; |            - acc:  o                                                                     |                                       |
; |____________________|_____________________________________________________________________|_______________________________________|
;                      |             ↑                                                       |             ↑                                 
;                      |             |                                                       |             |                              
;                      |             |                                                       |             |                            
;  ____________________↓_____________|________________________           ____________________↓_____________|________________________ 
; |                 |                                         |         |                 |                                         |
; |     code        |     environment: E1                     |         |     code        |     environment: E2                     |
; |_________________|-----------------------------------------|         |_________________|-----------------------------------------|
;                   |     balance: 30                         |                           |     balance: 100                        |
;                   |                                         |                           |                                         |
;                   |     withdraw:   - Function code         |                           |     withdraw:   - Function code         |
;                   |                 - Pointer: E1           |                           |                 - Pointer: E2           |
;                   |                                         |                           |                                         |
;                   |     deposit:    - Function code         |                           |     deposit:    - Function code         |
;                   |                 - Pointer: E1           |                           |                 - Pointer: E2           |
;                   |                                         |                           |                                         |
;                   |     dispatch:   - Function code         |                           |     dispatch:   - Function code         |
;                   |                 - Pointer: E1           |                           |                 - Pointer: E2           |
;                   |_________________________________________|                           |_________________________________________|



; How are the local states for the two accounts kept distinct?
;
; The calls to make-account create a new environment each time. E1 was created
; for acc and E2 for acc2. This way, each environment keeps a different instance
; of the balance variable.


; Which parts of the environment structure are shared between `acc` and `acc2`?
;
; The only thing they share is the global_env. Everything else is contained in
; their respective environments.
; Although we might think that the code for the `deposit`, `withdraw`, and
; `dispatch` functions is the same in both environments, this is not the case,
; although it could be an optimization to consider.